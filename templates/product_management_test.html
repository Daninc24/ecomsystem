<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .product-images { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .product-image { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .image-upload-area { border: 2px dashed #ddd; padding: 20px; text-align: center; margin: 10px 0; }
        .image-upload-area:hover { border-color: #007bff; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Product Management Test</h1>
    
    <div class="section">
        <h2>Authentication Status</h2>
        <p>Current User: {{ current_user.email if current_user.is_authenticated else 'Not logged in' }}</p>
        <p>Is Admin: {{ current_user.has_role('admin') if current_user.is_authenticated else 'N/A' }}</p>
    </div>

    <div class="section">
        <h2>Product Management Actions</h2>
        <button class="btn btn-success" onclick="showCreateProductModal()">Create New Product</button>
        <button class="btn btn-primary" onclick="loadProducts()">Load Products</button>
        <button class="btn btn-warning" onclick="loadCategories()">Load Categories</button>
        <div id="action-log"></div>
    </div>

    <div class="section">
        <h2>Products</h2>
        <div id="products-container" class="product-grid">
            <!-- Products will be loaded here -->
        </div>
    </div>

    <!-- Create/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2 id="modalTitle">Create Product</h2>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price *</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productSku">SKU</label>
                    <input type="text" id="productSku">
                </div>
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="productInventory">Inventory Quantity</label>
                    <input type="number" id="productInventory" value="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productActive" checked> Active
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productFeatured"> Featured
                    </label>
                </div>
                
                <h3>Product Images</h3>
                <div class="image-upload-area" onclick="document.getElementById('imageUpload').click()">
                    <p>Click to upload images or drag and drop</p>
                    <input type="file" id="imageUpload" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>
                <div id="imagePreview"></div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Product</button>
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentProductId = null;
        let currentImages = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('action-log');
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            logDiv.appendChild(entry);
            console.log(message);
        }

        async function loadProducts() {
            log('Loading products...');
            try {
                const response = await fetch('/api/admin/products/', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayProducts(data.data.products);
                        log(`Loaded ${data.data.products.length} products`, 'success');
                    } else {
                        log(`Failed to load products: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                const imagesHtml = product.images && product.images.length > 0 
                    ? product.images.map(img => `<img src="${img}" class="product-image" alt="Product image">`).join('')
                    : '<p>No images</p>';
                
                card.innerHTML = `
                    <h4>${product.name}</h4>
                    <p><strong>Price:</strong> $${product.price}</p>
                    <p><strong>SKU:</strong> ${product.sku || 'N/A'}</p>
                    <p><strong>Stock:</strong> ${product.inventory_quantity}</p>
                    <p><strong>Status:</strong> ${product.is_active ? 'Active' : 'Inactive'}</p>
                    <div class="product-images">${imagesHtml}</div>
                    <button class="btn btn-primary" onclick="editProduct(${product.id})">Edit</button>
                    <button class="btn btn-warning" onclick="manageImages(${product.id})">Manage Images</button>
                    <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                `;
                container.appendChild(card);
            });
        }

        function showCreateProductModal() {
            currentProductId = null;
            currentImages = [];
            document.getElementById('modalTitle').textContent = 'Create Product';
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function editProduct(productId) {
            log(`Loading product ${productId} for editing...`);
            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const product = data.data.product;
                        currentProductId = productId;
                        currentImages = product.images || [];
                        
                        document.getElementById('modalTitle').textContent = 'Edit Product';
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productPrice').value = product.price;
                        document.getElementById('productSku').value = product.sku || '';
                        document.getElementById('productDescription').value = product.description || '';
                        document.getElementById('productInventory').value = product.inventory_quantity;
                        document.getElementById('productActive').checked = product.is_active;
                        document.getElementById('productFeatured').checked = product.is_featured;
                        
                        // Display current images
                        displayCurrentImages();
                        
                        document.getElementById('productModal').style.display = 'block';
                        log('Product loaded for editing', 'success');
                    } else {
                        log(`Failed to load product: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        }

        function displayCurrentImages() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<h4>Current Images:</h4>';
            
            currentImages.forEach((imageUrl, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.style.display = 'inline-block';
                imageDiv.style.margin = '10px';
                imageDiv.innerHTML = `
                    <img src="${imageUrl}" class="image-preview" alt="Product image">
                    <br>
                    <button type="button" class="btn btn-danger" onclick="removeImage(${index})">Remove</button>
                `;
                preview.appendChild(imageDiv);
            });
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            displayCurrentImages();
        }

        async function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            if (!currentProductId) {
                log('Please save the product first before uploading images', 'error');
                return;
            }

            for (let file of files) {
                await uploadImage(file);
            }
        }

        async function uploadImage(file) {
            log(`Uploading image: ${file.name}`);
            
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`/api/admin/products/${currentProductId}/images`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentImages.push(data.data.image_url);
                        displayCurrentImages();
                        log(`Image uploaded successfully: ${data.data.filename}`, 'success');
                    } else {
                        log(`Failed to upload image: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error uploading image: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error uploading image: ${error.message}`, 'error');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                sku: document.getElementById('productSku').value,
                description: document.getElementById('productDescription').value,
                inventory_quantity: parseInt(document.getElementById('productInventory').value),
                is_active: document.getElementById('productActive').checked,
                is_featured: document.getElementById('productFeatured').checked,
                images: currentImages
            };

            try {
                const url = currentProductId 
                    ? `/api/admin/products/${currentProductId}`
                    : '/api/admin/products/';
                
                const method = currentProductId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        log(`Product ${currentProductId ? 'updated' : 'created'} successfully`, 'success');
                        closeProductModal();
                        loadProducts(); // Reload products
                        
                        // If creating new product, set the ID for image uploads
                        if (!currentProductId) {
                            currentProductId = data.data.product.id;
                        }
                    } else {
                        log(`Failed to save product: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        });

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            log(`Deleting product ${productId}...`);
            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        log('Product deleted successfully', 'success');
                        loadProducts(); // Reload products
                    } else {
                        log(`Failed to delete product: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        }

        async function loadCategories() {
            log('Loading categories...');
            try {
                const response = await fetch('/api/admin/products/categories', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        log(`Loaded ${data.data.categories.length} categories`, 'success');
                        console.log('Categories:', data.data.categories);
                    } else {
                        log(`Failed to load categories: ${data.error}`, 'error');
                    }
                } else {
                    log(`HTTP Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        }

        // Load products on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });
    </script>
</body>
</html>