{% extends "seo_base.html" %}

{% block title %}{% if request.args.get('category') %}{{ request.args.get('category') }} Products{% else %}All Products{% endif %} - {{ store_config.name }}{% endblock %}
{% block description %}{% if request.args.get('category') %}Shop {{ request.args.get('category') }} products{% else %}Browse millions of products{% endif %} from trusted sellers worldwide. Find the best deals with secure payments and buyer protection.{% endblock %}
{% block keywords %}{% if request.args.get('category') %}{{ request.args.get('category') }}, {% endif %}products, online shopping, marketplace, best deals, secure shopping{% endblock %}

{% block schema_type %}CollectionPage{% endblock %}
{% block schema_data %},
"mainEntity": {
    "@type": "ItemList",
    "name": "{% if request.args.get('category') %}{{ request.args.get('category') }} Products{% else %}All Products{% endif %}",
    "numberOfItems": {{ total_products }}
}{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
    <div class="container">
        <ol class="breadcrumb-list">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            {% if request.args.get('category') %}
            <li><a href="{{ url_for('products') }}">Products</a></li>
            <li aria-current="page">{{ request.args.get('category') }}</li>
            {% else %}
            <li aria-current="page">Products</li>
            {% endif %}
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<!-- Products Header -->
<section class="products-header">
    <div class="container">
        <div class="products-header-content">
            <h1 class="products-title">Discover Amazing Products</h1>
            <p class="products-subtitle">{{ total_products }} products found</p>
        </div>
        
        <!-- Filters and Sorting -->
        <div class="products-controls">
            <div class="filters-section">
                <div class="filter-group">
                    <label>Category:</label>
                    <select id="category-filter" class="filter-select">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.icon }} {{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Price Range:</label>
                    <div class="price-range">
                        <input type="number" id="min-price" placeholder="Min" class="price-input">
                        <span>-</span>
                        <input type="number" id="max-price" placeholder="Max" class="price-input">
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Sort by:</label>
                    <select id="sort-filter" class="filter-select">
                        <option value="name">Name A-Z</option>
                        <option value="price_asc">Price: Low to High</option>
                        <option value="price_desc">Price: High to Low</option>
                        <option value="newest">Newest First</option>
                        <option value="popular">Most Popular</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                </div>
                
                <button id="apply-filters" class="apply-filters-btn">Apply Filters</button>
            </div>
        </div>
    </div>
</section>

<!-- Products Grid -->
<section class="products-section">
    <div class="container">
        <div id="products-grid" class="products-grid">
            {% for product in products.items %}
            <div class="product-card animate-fade-in-up" onclick="window.location.href='{{ url_for('product_detail', slug=product.slug) }}'">
                <div class="product-image-wrapper">
                    <img src="{{ product.get_main_image() }}" alt="{{ product.name }}" class="product-image" loading="lazy">
                    
                    <div class="product-badges">
                        {% if product.get_discount_percentage() > 0 %}
                        <span class="badge badge-discount">-{{ product.get_discount_percentage() }}%</span>
                        {% endif %}
                        {% if product.is_featured %}
                        <span class="badge badge-featured">Featured</span>
                        {% endif %}
                    </div>
                    
                    <div class="product-actions">
                        <button class="action-btn" title="Add to Wishlist">
                            <span>‚ô°</span>
                        </button>
                        <button class="action-btn" title="Quick View">
                            <span>üëÅ</span>
                        </button>
                        <button class="action-btn add-to-cart-btn" 
                                onclick="event.stopPropagation(); window.location.href='{{ url_for('add_to_cart', product_id=product.id) }}'" 
                                title="Add to Cart">
                            <span>üõí</span>
                        </button>
                    </div>
                </div>
                
                <div class="product-info">
                    <h3 class="product-name">{{ product.name }}</h3>
                    <p class="product-description">{{ product.short_description or (product.description[:100] + '...' if product.description else 'No description available') }}</p>
                    
                    <div class="product-pricing">
                        <span class="current-price">${{ "%.2f"|format(product.price) }}</span>
                        {% if product.compare_price and product.compare_price > product.price %}
                        <span class="original-price">${{ "%.2f"|format(product.compare_price) }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="product-meta">
                        <div class="product-rating">
                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                            <span class="rating-text">(4.5)</span>
                        </div>
                        <div class="product-stock">
                            {% if product.is_in_stock() %}
                            <span class="in-stock">In Stock</span>
                            {% else %}
                            <span class="out-of-stock">Out of Stock</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if products.pages > 1 %}
        <div class="pagination-wrapper">
            <nav class="pagination">
                {% if products.has_prev %}
                <a href="{{ url_for('products', page=products.prev_num, search=search_query, category=current_category) }}" class="pagination-btn">‚Üê Previous</a>
                {% endif %}
                
                <div class="pagination-numbers">
                    {% for page_num in products.iter_pages() %}
                        {% if page_num %}
                            {% if page_num == products.page %}
                            <span class="pagination-number active">{{ page_num }}</span>
                            {% else %}
                            <a href="{{ url_for('products', page=page_num, search=search_query, category=current_category) }}" class="pagination-number">{{ page_num }}</a>
                            {% endif %}
                        {% else %}
                            <span class="pagination-ellipsis">‚Ä¶</span>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if products.has_next %}
                <a href="{{ url_for('products', page=products.next_num, search=search_query, category=current_category) }}" class="pagination-btn">Next ‚Üí</a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>
</section>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Loading products...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dynamic filtering
    const applyFiltersBtn = document.getElementById('apply-filters');
    const loadingOverlay = document.getElementById('loading-overlay');
    const productsGrid = document.getElementById('products-grid');
    
    applyFiltersBtn.addEventListener('click', function() {
        const filters = {
            categories: document.getElementById('category-filter').value ? [document.getElementById('category-filter').value] : [],
            price_max: parseFloat(document.getElementById('max-price').value) || null,
            sort: document.getElementById('sort-filter').value,
            search: new URLSearchParams(window.location.search).get('search') || ''
        };
        
        // Show loading
        loadingOverlay.style.display = 'flex';
        
        // Make API call
        fetch('/api/products/filter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProductsGrid(data.products);
            } else {
                console.error('Filter error:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            loadingOverlay.style.display = 'none';
        });
    });
    
    function updateProductsGrid(products) {
        productsGrid.innerHTML = '';
        
        products.forEach(product => {
            const productCard = createProductCard(product);
            productsGrid.appendChild(productCard);
        });
    }
    
    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card animate-fade-in-up';
        card.onclick = () => window.location.href = `/product/${product.id}`;
        
        card.innerHTML = `
            <div class="product-image-wrapper">
                <img src="${product.image_url}" alt="${product.name}" class="product-image" loading="lazy">
                
                <div class="product-badges">
                    ${product.discount_percentage > 0 ? `<span class="badge badge-discount">-${Math.round(product.discount_percentage)}%</span>` : ''}
                    ${product.is_featured ? '<span class="badge badge-featured">Featured</span>' : ''}
                </div>
                
                <div class="product-actions">
                    <button class="action-btn" title="Add to Wishlist">
                        <span>‚ô°</span>
                    </button>
                    <button class="action-btn" title="Quick View">
                        <span>üëÅ</span>
                    </button>
                    <button class="action-btn add-to-cart-btn" 
                            data-product-id="${product.id}" 
                            title="Add to Cart">
                        <span>üõí</span>
                    </button>
                </div>
            </div>
            
            <div class="product-info">
                <h3 class="product-name">${product.name}</h3>
                <p class="product-description">${product.description.substring(0, 100)}...</p>
                
                <div class="product-pricing">
                    <span class="current-price">$${product.price.toFixed(2)}</span>
                </div>
                
                <div class="product-meta">
                    <div class="product-rating">
                        <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-text">(4.5)</span>
                    </div>
                    <div class="product-stock">
                        <span class="in-stock">In Stock</span>
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
});
</script>
{% endblock %}